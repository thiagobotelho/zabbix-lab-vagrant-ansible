---
- name: Verificar se o pacote zabbix-release está instalado
  command: dpkg-query -W -f='${Status}' zabbix-release
  register: zabbix_release_status
  changed_when: false
  failed_when: zabbix_release_status.rc not in [0, 1]

- name: Adicionar repositório Zabbix
  block:
    - name: Baixar pacote do repositório Zabbix
      get_url:
        url: https://repo.zabbix.com/zabbix/7.0/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_7.0+ubuntu22.04_all.deb
        dest: /tmp/zabbix-release.deb
        mode: '0644'

    - name: Instalar repositório Zabbix
      apt:
        deb: /tmp/zabbix-release.deb
        state: present

    - name: Atualizar cache do APT
      apt:
        update_cache: yes
  when: "'install ok installed' not in zabbix_release_status.stdout"

- name: Instalar Zabbix Proxy com suporte a SQLite3
  apt:
    name: zabbix-proxy-sqlite3
    state: present
    update_cache: yes

- name: Garantir que o diretório /var/lib/zabbix exista com as permissões corretas
  file:
    path: /var/lib/zabbix
    state: directory
    owner: zabbix
    group: zabbix
    mode: '0755'

- name: Configurar Server no zabbix_proxy.conf
  lineinfile:
    path: /etc/zabbix/zabbix_proxy.conf
    regexp: '^#?\s*Server='
    line: "Server={{ zabbix_server_ip }}"
    create: yes
    backup: yes

- name: Configurar Hostname no zabbix_proxy.conf
  lineinfile:
    path: /etc/zabbix/zabbix_proxy.conf
    regexp: '^#?\s*Hostname='
    line: "Hostname={{ inventory_hostname }}"
    create: yes
    backup: yes

- name: Configurar DBName para SQLite3 no zabbix_proxy.conf
  lineinfile:
    path: /etc/zabbix/zabbix_proxy.conf
    regexp: '^#?\s*DBName='
    line: 'DBName=/var/lib/zabbix/zabbix_proxy.db'
    create: yes
    backup: yes
  notify: Restart Zabbix Proxy

- name: Habilitar e iniciar o serviço do Zabbix Proxy
  service:
    name: zabbix-proxy
    state: started
    enabled: yes
